\documentclass[aspectratio=169]{beamer}
\usetheme[numbering=fraction]{metropolis}
%% Layout options
\setbeamertemplate{frame footer}{\inserttitle} %% Footer with title.
\setbeamerfont{page number in head/foot}{size=\tiny}
\setbeamertemplate{bibliography item}{\insertbiblabel} %% Make [1] work in bibliography.
\setbeamertemplate{caption}{\raggedright\insertcaption\par} %% Remove 'Figure X' from caption.
\setbeamercolor{background canvas}{bg=white}

\input{0itemize.tex}

\usepackage{verbatimbox, stackengine}
\usepackage{listings}

\title{Connecting CoreDNS to Envoy's Discovery Control Plane}
\date{April/March 2020}
\author{Miek Gieben (miek@miek.nl) \and Michael Grosser (xxxk@yyy.zzz)}
\institute{Centre for protobuf Nerding}

\lstdefinelanguage{proto}{
    morekeywords={version_info, type_url, DiscoveryRequest, DiscoveryResponse},
    basicstyle=\small,
}

\begin{document}
    \let\oldfootnotesize\footnotesize
    \renewcommand*{\footnotesize}{\oldfootnotesize\tiny}

    \maketitle

    \section{What's Envoy and Envoy's Discovery Protocol?}
    \begin{frame}{Envoy}

    \end{frame}

    \begin{frame}{Envoy's Discovery Protocol}
        \begin{itemize}
            \item Envoy is dynamically configurable using \emph{Discovery Services} (DS)
            \item It can:
            \begin{itemize}
                \item configure new listeners (open new sockets) $\rightarrow$ Listeners Discovery Service (\emph{L}DS)
                \item configure new routes (map \texttt{/api} to \texttt{X}, etc.) $\rightarrow$ Route Discovery Service (\emph{R}DS)
                \item configure new clusters (a name + endpoints) $\rightarrow$ Cluster Discovery Service (\emph{C}DS)
                \item configure new endpints (address:port) $\rightarrow$ Endpoint Discovery Service (\emph{E}DS)
            \end{itemize}
        \end{itemize}

        All these DSs together are called {\bf xDS}, we care about CDS/EDS
    \end{frame}

    \begin{frame}{ADS}
        Protocol uses 2 gRPC messages, you either
        \begin{itemize}
            \item call a service, i.e. \texttt{FetchEndpoints}
            \item bidirectional stream + indicate type $\rightarrow$ Aggregated Discovery Service (\emph{A}DS)
        \end{itemize}

        \begin{columns}[T]
            \begin{column}{0.5\textwidth}
                \lstinputlisting[language=proto]{discovery-request.proto}
            \end{column}
            \begin{column}{0.5\textwidth}
                \lstinputlisting[language=proto]{discovery-response.proto}
            \end{column}
        \end{columns}
    \end{frame}

    \begin{frame}[plain]{\texttt{xds} Control Loop}
        \begin{columns}
            \begin{column}{0.5\textwidth}
                \includegraphics[scale=0.6]{xds-bin.pdf}
            \end{column}
            \begin{column}{0.5\textwidth}
                Anything implementing ADS can subscribe to the feed
            \end{column}
        \end{columns}
    \end{frame}

    \section{CoreDNS with \emph{traffic}}

    \begin{frame}{Setup for Demo}
            \includegraphics[scale=0.6]{xds-overview.pdf}
    \end{frame}

    \begin{frame}{}
        \begin{description}
            \item[hc]
                \begin{itemize}
                    \item Not available in this presentation
                    \item Will be done manually in this presentation
                \end{itemize}
            \item[xds]
                \begin{itemize}
                    \item \texttt{xds} - Main control plane component
                    \item Go binary that implements Envoy xDS v3
                    \item \url{github.com/miekg/xds}
                \end{itemize}
            \item[cli]
                \begin{itemize}
                    \item \texttt{xdsctl} - CLI to manipulate \texttt{xds}, this is what oncallers to use
                    \item Go binary that implements Envoy xDS v3 client side
                    \item \url{github.com/miekg/xds/tree/master/cmd/xdsctl}
                \end{itemize}
            \item[dns]
                \begin{itemize}
                    \item \texttt{CoreDNS} - with \emph{traffic} plugin
                    \item Go binary that implements Envoy xDS v3 ADS
                    \item \url{github.com/coredns/coredns/tree/traffic}
                \end{itemize}
        \end{description}
    \end{frame}

    \section{Demo}
    \begin{frame}[fragile]
        \begin{verbatim}
% xds
[INFO] Initialized cache with 'v1' of 1 cluster parsed
from directory: "."
[INFO] Management server listening on :18000
        \end{verbatim}

        \begin{verbatim}
% xdsctl ls
CLUSTER  VERSION  TYPE  METADATA
web      1        EDS
        \end{verbatim}
    \end{frame}

    \begin{frame}[fragile]
        \begin{verbatim}
% xdsctl ls web
CLUSTER  VERSION  ENDPOINT        LOCALITY  HEALTH   WEIGHT
web      1        192.168.1.1:80  us        HEALTHY  0
web      1        192.168.1.2:80  us        HEALTHY  0
web      1        172.16.0.1:80   eu        HEALTHY  0
web      1        172.16.0.2:80   eu        HEALTHY  0
        \end{verbatim}

    \end{frame}

    \begin{frame}[fragile]

        \begin{verbbox}
% xdsctl drain web 192.168.1.1:80
% xdsctl ls web
CLUSTER  VERSION  ENDPOINT        LOCALITY  HEALTH    WEIGHT
web      2        192.168.1.1:80  us        DRAINING  0
web      2        192.168.1.2:80  us        HEALTHY   0
web      2        172.16.0.1:80   eu        HEALTHY   0
web      2        172.16.0.2:80   eu        HEALTHY   0
        \end{verbbox}
        \stackinset{l}{53pt}{b}{12pt}{{\framebox(55,78){}}}{%
        \stackinset{l}{285pt}{b}{58pt}{{\framebox(62,18){}}}{\theverbbox}%
        }

    \end{frame}

    \begin{frame}[fragile]

        \begin{verbbox}
% xdsctl undrain web 192.168.1.1:80
% xdsctl ls web
CLUSTER  VERSION  ENDPOINT        LOCALITY  HEALTH   WEIGHT
web      3        192.168.1.1:80  us        UNKNOWN  0
web      3        192.168.1.2:80  us        HEALTHY  0
web      3        172.16.0.1:80   eu        HEALTHY  0
web      3        172.16.0.2:80   eu        HEALTHY  0
        \end{verbbox}
        \stackinset{l}{53pt}{b}{12pt}{{\framebox(55,78){}}}{%
        \stackinset{l}{285pt}{b}{58pt}{{\framebox(62,18){}}}{\theverbbox}%
        }

    \end{frame}

    \begin{frame}{Remaining Items}
        Work that remains consists out of
        \begin{itemize}
            \item Writing Go binary for health checking
            \item Localization support in \texttt{xds} and \emph{traffic}
            \item Fail safe: all endpoints are unhealtly $\rightarrow$ assume HC failure?
            \item Drain state, while discovering new endpoints.
            \item Authn/authz?
        \end{itemize}

        DNS disobeyers. Clients don't refresh their assignment, so will break at some point.
        This is why TTL was invented.
        Delays and interaction with DNS TTL and our 10s cycle.
    \end{frame}

\end{document}
